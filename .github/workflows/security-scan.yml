# .github/workflows/security-scan.yml
name: Seguridad CI

on:
  push:
    branches: [master]
  pull_request:

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Preparar carpeta de resultados
        run: mkdir -p results

      - id: skims
        name: Escaneo SAST con Skims
        continue-on-error: true
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            fluidattacks/cli:latest \
            skims --strict scan skims-config.yml

      - id: trivy
        continue-on-error: true
        name: Escaneo con Trivy
        uses: aquasecurity/trivy-action@0.30.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-config: trivy-config.yaml

      - name: Subir reportes de seguridad
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: results/*.csv

      - name: Comprobar vulnerabilidades y fallar build
        if: always()
        run: |
          if [[ "${{ steps.skims.outcome }}" == "failure" ]] || [[ "${{ steps.trivy.outcome }}" == "failure" ]]; then
            echo "::error::Se detectaron vulnerabilidades (Skims=${{ steps.skims.outcome }}, Trivy=${{ steps.trivy.outcome }})"
            exit 1
          fi
