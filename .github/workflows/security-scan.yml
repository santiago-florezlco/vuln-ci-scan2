# .github/workflows/security-scan.yml
name: Seguridad CI

on:
  push:
    branches: [master]
  pull_request:

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Preparar carpeta de resultados
        run: mkdir -p results

      - id: skims
        name: Escaneo SAST con Skims
        continue-on-error: true
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            fluidattacks/cli:latest \
            skims --strict scan skims-config.yml

      - id: trivy
        name: Escaneo con Trivy
        continue-on-error: true
        run: |
          mkdir -p results
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            aquasec/trivy:0.60.0 \
            fs . \
            --list-all-pkgs \
            --format template \
            --template "{{- range . -}}{{- range .Vulnerabilities -}}{{ .Target }},{{ .PkgName }},{{ .VulnerabilityID }},{{ .Severity }}\n{{- end }}{{- end }}" \
            --severity HIGH,CRITICAL \
            --ignore-unfixed \
            --exit-code 1 \
            --output results/trivy-report.csv
      
      - name: Verificar CSV de Trivy
        if: always()
        run: |
          echo "üöÄ Contenido de results/:"
          ls -l results
          echo "‚è∫ Primeras l√≠neas de trivy-report.csv:"
          head -n 5 results/trivy-report.csv || echo "(archivo vac√≠o o no existe)"

      - name: Subir reportes de seguridad
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: results/*.csv

      - name: Comprobar vulnerabilidades y fallar build
        if: always()
        run: |
          if [[ "${{ steps.skims.outcome }}" == "failure" ]] || [[ "${{ steps.trivy.outcome }}" == "failure" ]]; then
            echo "::error::Se detectaron vulnerabilidades (Skims=${{ steps.skims.outcome }}, Trivy=${{ steps.trivy.outcome }})"
            exit 1
          fi
